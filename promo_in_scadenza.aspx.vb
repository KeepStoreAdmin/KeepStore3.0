
Partial Class promo_in_scadenza
    Inherits System.Web.UI.Page

    Public cont As Integer = 0

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        If Not Request.QueryString("ct") Is Nothing Then
            'sdsArticoli.SelectCommand = "SELECT articol_1.Articoli_id, articol_1.offerta_AziendeID,articol_1.Articoli_Codice, articol_1.Articoli_Ean,articol_1.Articoli_Descrizione1,IF(articol_1.ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1,articol_1.ListinoUfficiale,IF(" & Session("Iva_Utente") & ">0,((articol_1.ListinoUfficiale)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.ListinoUfficiale) * ((iva/100)+1)))),IF(" & Session("IvaTipo") & "=1,Prezzo,IF(" & Session("Iva_Utente") & ">0,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((Prezzo) * ((iva/100)+1))))) AS Listino_Ufficiale,articol_1.Articoli_Descrizione2,articol_1.Articoli_Img1,articol_1.Articoli_SpedizioneGratis_Listini,IF(((CURDATE()>=articol_1.Articoli_SpedizioneGratis_Data_Inizio) AND (CURDATE()<=articol_1.Articoli_SpedizioneGratis_Data_Fine)),1,0) AS SpeditoGratis,articol_1.offerta_DataInizio,articol_1.offerta_DataFine,articol_1.offerta_DaListino,articol_1.offerta_AListino,articol_1.offerta_QntMinima,articol_1.offerta_Multipli,articol_1.offerta_Prezzo,articol_1.MarcheId,articol_1.SettoriId,articol_1.CategorieId,articol_1.TipologieId,articol_1.GruppiId,articol_1.SottogruppiId,NListino AS Listino_Articolo_NListino,iva AS Listino_Articolo_iva,Prezzo AS Listino_Articolo_Prezzo,PrezzoIvato AS Listino_Articolo_PrezzoIvato, MIN(articol_1.offerta_Prezzo), IF(" & Session("Iva_Utente") & ">0,((articol_1.offerta_Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.offerta_Prezzo) * ((iva/100)+1))) AS offerta_prezzo_ivato FROM articoli_listini JOIN (SELECT id AS Articoli_id, Codice AS Articoli_Codice, Ean AS Articoli_Ean, Descrizione1 AS Articoli_Descrizione1, Descrizione2 AS Articoli_Descrizione2, Img1 AS Articoli_Img1, Abilitato AS Articoli_Abilitato, SpedizioneGratis_Listini AS Articoli_SpedizioneGratis_Listini, SpedizioneGratis_Data_Inizio AS Articoli_SpedizioneGratis_Data_Inizio, SpedizioneGratis_Data_Fine AS Articoli_SpedizioneGratis_Data_Fine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottoGruppiId,offerta_AziendeID, offerta_DataInizio, offerta_DataFine, offerta_DaListino, offerta_AListino, offerta_QntMinima, offerta_Multipli, offerta_Prezzo, ListinoUfficiale FROM articoli JOIN (SELECT AziendeID AS offerta_AziendeID, DataInizio AS offerta_DataInizio, DataFine AS offerta_DataFine, DaListino AS offerta_DaListino, AListino AS offerta_AListino, QntMinima AS offerta_QntMinima, Multipli AS offerta_Multipli, Prezzo AS offerta_Prezzo, Abilitato AS offerta_Abilitato, ArticoliId AS offerta_ArticoliId FROM offerte JOIN offertedettaglio ON offerte.id=OfferteId WHERE Abilitato=1) AS offerte_1 ON id=offerte_1.offerta_ArticoliId WHERE Abilitato=1) AS articol_1 ON ArticoliId=articol_1.Articoli_id WHERE (DATEDIFF(articol_1.offerta_DataFine,CURDATE()) BETWEEN 0 AND 7 ) AND (NListino=" & Me.Session("listino") & ") AND ((" & Me.Session("listino") & ">=articol_1.offerta_DaListino) AND (" & Me.Session("listino") & "<=articol_1.offerta_AListino)) AND (articol_1.offerta_AziendeID=" & Me.Session("AziendaID") & ") AND (articol_1.CategorieId=" & Request.QueryString("ct") & ") Group By Articoli_id"
            'Opzioni di ordinamento
            If Drop_Ordinamento.SelectedValue = "P_data_scadenza" Then
                sdsArticoli.SelectCommand = "SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND (inofferta=1) AND (CategorieId=" & Request.QueryString("ct") & ") AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY OfferteDatafine ASC"
            End If
            If Drop_Ordinamento.SelectedValue = "P_decrescente" Then
                sdsArticoli.SelectCommand = "SELECT SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND (inofferta=1) AND (CategorieId=" & Request.QueryString("ct") & ") AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY PrezzoPromo DESC"
            End If
            If Drop_Ordinamento.SelectedValue = "P_crescente" Then
                sdsArticoli.SelectCommand = "SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND (inofferta=1) AND (CategorieId=" & Request.QueryString("ct") & ") AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY PrezzoPromo ASC"
            End If
        Else
            'sdsArticoli.SelectCommand = "SELECT articol_1.Articoli_id, articol_1.offerta_AziendeID,articol_1.Articoli_Codice, articol_1.Articoli_Ean,articol_1.Articoli_Descrizione1,IF(articol_1.ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1,articol_1.ListinoUfficiale,IF(" & Session("Iva_Utente") & ">0,((articol_1.ListinoUfficiale)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.ListinoUfficiale) * ((iva/100)+1)))),IF(" & Session("IvaTipo") & "=1,Prezzo,IF(" & Session("Iva_Utente") & ">0,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((Prezzo) * ((iva/100)+1))))) AS Listino_Ufficiale,articol_1.Articoli_Descrizione2,articol_1.Articoli_Img1,articol_1.Articoli_SpedizioneGratis_Listini,IF(((CURDATE()>=articol_1.Articoli_SpedizioneGratis_Data_Inizio) AND (CURDATE()<=articol_1.Articoli_SpedizioneGratis_Data_Fine)),1,0) AS SpeditoGratis,articol_1.offerta_DataInizio,articol_1.offerta_DataFine,articol_1.offerta_DaListino,articol_1.offerta_AListino,articol_1.offerta_QntMinima,articol_1.offerta_Multipli,articol_1.offerta_Prezzo,articol_1.MarcheId,articol_1.SettoriId,articol_1.CategorieId,articol_1.TipologieId,articol_1.GruppiId,articol_1.SottogruppiId,NListino AS Listino_Articolo_NListino,iva AS Listino_Articolo_iva,Prezzo AS Listino_Articolo_Prezzo,PrezzoIvato AS Listino_Articolo_PrezzoIvato, MIN(articol_1.offerta_Prezzo), IF(" & Session("Iva_Utente") & ">0,((articol_1.offerta_Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.offerta_Prezzo) * ((iva/100)+1))) AS offerta_prezzo_ivato FROM articoli_listini JOIN (SELECT id AS Articoli_id, Codice AS Articoli_Codice, Ean AS Articoli_Ean, Descrizione1 AS Articoli_Descrizione1, Descrizione2 AS Articoli_Descrizione2, Img1 AS Articoli_Img1, Abilitato AS Articoli_Abilitato, SpedizioneGratis_Listini AS Articoli_SpedizioneGratis_Listini, SpedizioneGratis_Data_Inizio AS Articoli_SpedizioneGratis_Data_Inizio, SpedizioneGratis_Data_Fine AS Articoli_SpedizioneGratis_Data_Fine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottoGruppiId,offerta_AziendeID, offerta_DataInizio, offerta_DataFine, offerta_DaListino, offerta_AListino, offerta_QntMinima, offerta_Multipli, offerta_Prezzo, ListinoUfficiale FROM articoli JOIN (SELECT AziendeID AS offerta_AziendeID, DataInizio AS offerta_DataInizio, DataFine AS offerta_DataFine, DaListino AS offerta_DaListino, AListino AS offerta_AListino, QntMinima AS offerta_QntMinima, Multipli AS offerta_Multipli, Prezzo AS offerta_Prezzo, Abilitato AS offerta_Abilitato, ArticoliId AS offerta_ArticoliId FROM offerte JOIN offertedettaglio ON offerte.id=OfferteId WHERE Abilitato=1) AS offerte_1 ON id=offerte_1.offerta_ArticoliId WHERE Abilitato=1) AS articol_1 ON ArticoliId=articol_1.Articoli_id WHERE (DATEDIFF(articol_1.offerta_DataFine,CURDATE()) BETWEEN 0 AND 7 ) AND (NListino=" & Me.Session("listino") & ") AND ((" & Me.Session("listino") & ">=articol_1.offerta_DaListino) AND (" & Me.Session("listino") & "<=articol_1.offerta_AListino)) AND (articol_1.offerta_AziendeID=" & Me.Session("AziendaID") & ") Group By Articoli_id"
            'Opzioni di ordinamento
            If Drop_Ordinamento.SelectedValue = "P_data_scadenza" Then
                'sdsArticoli.SelectCommand = "SELECT articol_1.Articoli_id, articol_1.offerta_AziendeID,articol_1.Articoli_Codice, articol_1.Articoli_Ean,articol_1.Articoli_Descrizione1,IF(articol_1.ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1,articol_1.ListinoUfficiale,IF(" & Session("Iva_Utente") & ">0,((articol_1.ListinoUfficiale)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.ListinoUfficiale) * ((iva/100)+1)))),IF(" & Session("IvaTipo") & "=1,Prezzo,IF(" & Session("Iva_Utente") & ">0,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((Prezzo) * ((iva/100)+1))))) AS Listino_Ufficiale,articol_1.Articoli_Descrizione2,articol_1.Articoli_Img1,articol_1.Articoli_SpedizioneGratis_Listini,IF(((CURDATE()>=articol_1.Articoli_SpedizioneGratis_Data_Inizio) AND (CURDATE()<=articol_1.Articoli_SpedizioneGratis_Data_Fine)),1,0) AS SpeditoGratis,articol_1.offerta_DataInizio,articol_1.offerta_DataFine,articol_1.offerta_DaListino,articol_1.offerta_AListino,articol_1.offerta_QntMinima,articol_1.offerta_Multipli,articol_1.offerta_Prezzo,articol_1.MarcheId,articol_1.SettoriId,articol_1.CategorieId,articol_1.TipologieId,articol_1.GruppiId,articol_1.SottogruppiId,NListino AS Listino_Articolo_NListino,iva AS Listino_Articolo_iva,Prezzo AS Listino_Articolo_Prezzo,PrezzoIvato AS Listino_Articolo_PrezzoIvato, MIN(articol_1.offerta_Prezzo), IF(" & Session("Iva_Utente") & ">0,((articol_1.offerta_Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),((articol_1.offerta_Prezzo) * ((iva/100)+1))) AS offerta_prezzo_ivato FROM articoli_listini JOIN (SELECT id AS Articoli_id, Codice AS Articoli_Codice, Ean AS Articoli_Ean, Descrizione1 AS Articoli_Descrizione1, Descrizione2 AS Articoli_Descrizione2, Img1 AS Articoli_Img1, Abilitato AS Articoli_Abilitato, SpedizioneGratis_Listini AS Articoli_SpedizioneGratis_Listini, SpedizioneGratis_Data_Inizio AS Articoli_SpedizioneGratis_Data_Inizio, SpedizioneGratis_Data_Fine AS Articoli_SpedizioneGratis_Data_Fine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottoGruppiId,offerta_AziendeID, offerta_DataInizio, offerta_DataFine, offerta_DaListino, offerta_AListino, offerta_QntMinima, offerta_Multipli, offerta_Prezzo, ListinoUfficiale FROM articoli JOIN (SELECT AziendeID AS offerta_AziendeID, DataInizio AS offerta_DataInizio, DataFine AS offerta_DataFine, DaListino AS offerta_DaListino, AListino AS offerta_AListino, QntMinima AS offerta_QntMinima, Multipli AS offerta_Multipli, Prezzo AS offerta_Prezzo, Abilitato AS offerta_Abilitato, ArticoliId AS offerta_ArticoliId FROM offerte JOIN offertedettaglio ON offerte.id=OfferteId WHERE Abilitato=1) AS offerte_1 ON id=offerte_1.offerta_ArticoliId WHERE Abilitato=1) AS articol_1 ON ArticoliId=articol_1.Articoli_id WHERE (DATEDIFF(articol_1.offerta_DataFine,CURDATE()) BETWEEN 0 AND 7 ) AND (NListino=" & Me.Session("listino") & ") AND ((" & Me.Session("listino") & ">=articol_1.offerta_DaListino) AND (" & Me.Session("listino") & "<=articol_1.offerta_AListino)) AND (articol_1.offerta_AziendeID=" & Me.Session("AziendaID") & ") Group By Articoli_id ORDER BY offerta_DataFine ASC"
                sdsArticoli.SelectCommand = "SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND inofferta=1 AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY OfferteDatafine ASC"
            End If
            If Drop_Ordinamento.SelectedValue = "P_decrescente" Then
                sdsArticoli.SelectCommand = "SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND inofferta=1 AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY PrezzoPromo DESC"
            End If
            If Drop_Ordinamento.SelectedValue = "P_crescente" Then
                sdsArticoli.SelectCommand = "SELECT id, Codice, Ean, Descrizione1, Descrizione2, DescrizioneIvaRC, SpeditoGratis, IF(DescrizioneLunga IS NULL,'',DescrizioneLunga) AS DescrizioneLunga, IF(DescrizioneHTML IS NULL,'',DescrizioneHTML) AS DescrizioneHTML, ArticoliIva, Prezzo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((Prezzo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((Prezzo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoIvato)) AS PrezzoIvato, Img1, MarcheDescrizione, Disponibilita, Giacenza, InOrdine, Impegnata, InOfferta, SettoriDescrizione, CategorieDescrizione, TipologieDescrizione, GruppiDescrizione, SottogruppiDescrizione, MarcheDescrizione, Marche_img, PrezzoPromo, IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato)) AS PrezzoPromoIvato, MarcheId, CategorieId, TipologieId, IF(PrezzoPromo IS NULL,Prezzo,PrezzoPromo) Ord_PrezzoPromo, IF(PrezzoPromoIvato IS NULL,PrezzoIvato,IF((" & Session("AbilitatoIvaReverseCharge") & "=1) AND (ValoreIvaRC>-1),((PrezzoPromo)*((ValoreIvaRC/100)+1)),IF(" & Session("Iva_Utente") & ">-1,((PrezzoPromo)*((" & Session("Iva_Utente") & "/100)+1)),PrezzoPromoIvato))) Ord_PrezzoPromoIvato, OfferteQntMinima, OfferteMultipli, OfferteDataInizio, OfferteDataFine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottogruppiId, Img1, Img2, Img3, Img4, Peso, Brochure, LinkProduttore, IF(ListinoUfficiale>0,IF(" & Session("IvaTipo") & "=1, ListinoUfficiale, ListinoUfficiale * ((iva/100)+1)),IF(" & Session("IvaTipo") & "=1,Prezzo,PrezzoIvato)) AS Listino_Ufficiale FROM (SELECT * FROM vsuperarticoli WHERE nlistino=" & Me.Session("listino") & " AND inofferta=1 AND (DATEDIFF(offerteDataFine,CURDATE()) BETWEEN 0 AND 7) ORDER BY prezzoPromo ASC) AS t1 GROUP BY id ORDER BY PrezzoPromo ASC"
            End If
        End If
        sdsCategorie.SelectCommand = "SELECT t1.Articolo_categoria, categorie.Descrizione, COUNT(t1.Articolo_categoria) AS cont FROM (SELECT articol_1.Articoli_id, articol_1.offerta_AziendeID,articol_1.Articoli_Codice, articol_1.Articoli_Ean,articol_1.Articoli_Descrizione1,articol_1.Articoli_Descrizione2,articol_1.Articoli_Img1,articol_1.Articoli_SpedizioneGratis_Listini,articol_1.Articoli_SpedizioneGratis_Data_Inizio,articol_1.Articoli_SpedizioneGratis_Data_Fine,articol_1.offerta_DataInizio,articol_1.offerta_DataFine,articol_1.offerta_DaListino,articol_1.offerta_AListino,articol_1.offerta_QntMinima,articol_1.offerta_Multipli,articol_1.offerta_Prezzo,articol_1.MarcheId,articol_1.SettoriId,articol_1.CategorieId AS Articolo_Categoria,articol_1.TipologieId,articol_1.GruppiId,articol_1.SottogruppiId,NListino AS Listino_Articolo_NListino,iva AS Listino_Articolo_iva,Prezzo AS Listino_Articolo_Prezzo,PrezzoIvato AS Listino_Articolo_PrezzoIvato, MIN(articol_1.offerta_Prezzo), IF(-1>0,((articol_1.offerta_Prezzo)*((-1/100)+1)),((articol_1.offerta_Prezzo) * ((iva/100)+1))) AS offerta_prezzo_ivato FROM articoli_listini JOIN (SELECT id AS Articoli_id, Codice AS Articoli_Codice, Ean AS Articoli_Ean, Descrizione1 AS Articoli_Descrizione1, Descrizione2 AS Articoli_Descrizione2, Img1 AS Articoli_Img1, Abilitato AS Articoli_Abilitato, SpedizioneGratis_Listini AS Articoli_SpedizioneGratis_Listini, SpedizioneGratis_Data_Inizio AS Articoli_SpedizioneGratis_Data_Inizio, SpedizioneGratis_Data_Fine AS Articoli_SpedizioneGratis_Data_Fine, MarcheId, SettoriId, CategorieId, TipologieId, GruppiId, SottoGruppiId,offerta_AziendeID, offerta_DataInizio, offerta_DataFine, offerta_DaListino, offerta_AListino, offerta_QntMinima, offerta_Multipli, offerta_Prezzo FROM articoli JOIN (SELECT AziendeID AS offerta_AziendeID, DataInizio AS offerta_DataInizio, DataFine AS offerta_DataFine, DaListino AS offerta_DaListino, AListino AS offerta_AListino, QntMinima AS offerta_QntMinima, Multipli AS offerta_Multipli, Prezzo AS offerta_Prezzo, Abilitato AS offerta_Abilitato, ArticoliId AS offerta_ArticoliId FROM offerte JOIN offertedettaglio ON offerte.id=OfferteId WHERE Abilitato=1) AS offerte_1 ON id=offerte_1.offerta_ArticoliId WHERE Abilitato=1) AS articol_1 ON ArticoliId=articol_1.Articoli_id WHERE (DATEDIFF(articol_1.offerta_DataFine,CURDATE()) BETWEEN 0 AND 7 ) AND (NListino=" & Me.Session("listino") & ") AND ((" & Me.Session("listino") & ">=articol_1.offerta_DaListino) AND (" & Me.Session("listino") & "<=articol_1.offerta_AListino)) AND (articol_1.offerta_AziendeID=" & Me.Session("AziendaID") & ") GROUP BY Articoli_id ORDER BY offerta_DataFine ASC) AS t1 JOIN Categorie ON Categorie.id=t1.Articolo_categoria GROUP BY t1.Articolo_categoria"
        DataList1.DataBind()
    End Sub

    Protected Sub sdsArticoli_Selecting(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.SqlDataSourceSelectingEventArgs) Handles sdsArticoli.Selecting
        e.Command.CommandTimeout = 0
    End Sub
End Class
